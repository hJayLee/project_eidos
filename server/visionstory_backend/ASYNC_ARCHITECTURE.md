# ë¹„ë™ê¸° ì•„ë°”íƒ€ ìƒì„± ì‹œìŠ¤í…œ

## ğŸ¯ ê°œìš”

ê°•ì‚¬ í”„ë¡œí•„ ì•„ë°”íƒ€ ìƒì„± ê¸°ëŠ¥ì„ **ë¹„ë™ê¸° ì•„í‚¤í…ì²˜**ë¡œ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.

### ì£¼ìš” íŠ¹ì§•

1. âœ… **ì¦‰ì‹œ ì‘ë‹µ**: ìš”ì²­ í›„ ì¦‰ì‹œ ì‘ì—… ID ë°˜í™˜
2. âœ… **ì‹¤ì‹œê°„ ì§„í–‰ ìƒí™©**: Firestoreë¡œ ë‹¨ê³„ë³„ ì§„í–‰ ìƒíƒœ í‘œì‹œ
3. âœ… **ì•± ì¢…ë£Œ ê°€ëŠ¥**: ìƒì„± ì¤‘ ì•±ì„ ê»ë‹¤ ì¼œë„ ì§„í–‰ ìƒí™© í™•ì¸
4. âœ… **ì¬ë¡œê·¸ì¸ ì§€ì›**: ë¡œê·¸ì•„ì›ƒ í›„ ë‹¤ì‹œ ë¡œê·¸ì¸í•´ë„ ì‘ì—… ì´ë ¥ í™•ì¸
5. âœ… **í™•ì¥ ê°€ëŠ¥**: 100ê°œ ì´ìƒ ìŠ¬ë¼ì´ë“œ ìƒì„±ì—ë„ ì ìš© ê°€ëŠ¥

## ğŸ—ï¸ ì•„í‚¤í…ì²˜

```
Flutter App
    â†“ 1. POST /generate-async (ì´ë¯¸ì§€ + ì˜¤ë””ì˜¤)
Backend API
    â†“ 2. ì¦‰ì‹œ jobId ë°˜í™˜
    â””â”€â†’ Firestoreì— ì‘ì—… ìƒì„± (status: pending)
    â””â”€â†’ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ë¹„ë””ì˜¤ ìƒì„± ì‹œì‘
         â†“
         â”œâ”€ Step 1: ì•„ë°”íƒ€ ìƒì„± (Firestore ì—…ë°ì´íŠ¸)
         â”œâ”€ Step 2: ë¹„ë””ì˜¤ ìƒì„± (Firestore ì—…ë°ì´íŠ¸)
         â””â”€ Step 3: ì™„ë£Œ (Firestore ì—…ë°ì´íŠ¸)
              â†“
Flutter App (Firestore ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë‹)
    â””â”€â†’ ì§„í–‰ ìƒí™© ìë™ ì—…ë°ì´íŠ¸
    â””â”€â†’ ì™„ë£Œ ì‹œ ë¹„ë””ì˜¤ ìë™ ì¬ìƒ
```

## ğŸ“ íŒŒì¼ êµ¬ì¡°

### Backend

```
server/visionstory_backend/
â”œâ”€â”€ src/
â”‚   â””â”€â”€ index.js          # ë¹„ë™ê¸° API ì—”ë“œí¬ì¸íŠ¸
â”œâ”€â”€ package.json          # firebase-admin í¬í•¨
â””â”€â”€ .env                  # VISIONSTORY_API_KEY
```

### Flutter

```
lib/
â”œâ”€â”€ data/models/
â”‚   â””â”€â”€ avatar_job.dart   # Firestore ë°ì´í„° ëª¨ë¸
â””â”€â”€ presentation/pages/instructor/
    â””â”€â”€ instructor_profile_page.dart  # Firestore ë¦¬ìŠ¤ë‹ + UI
```

### Firestore ë°ì´í„° êµ¬ì¡°

```javascript
// avatarJobs/{jobId}
{
  userId: "user_123",
  instructorName: "í™ê¸¸ë™",
  instructorBio: "ê°•ì‚¬ ì†Œê°œ...",
  
  status: "processing",  // pending, processing, completed, failed
  
  progress: {
    currentStep: "video_generation",
    stepNumber: 2,
    totalSteps: 3,
    message: "ì˜ìƒ ìƒì„± ì¤‘..."
  },
  
  videoUrl: null,  // ì™„ë£Œ ì‹œ ì±„ì›Œì§
  errorMessage: null,  // ì‹¤íŒ¨ ì‹œ ì±„ì›Œì§
  
  createdAt: Timestamp,
  updatedAt: Timestamp,
  completedAt: Timestamp  // ì™„ë£Œ ì‹œ
}
```

## ğŸš€ ì‚¬ìš© ë°©ë²•

### 1. ë°±ì—”ë“œ ì„œë²„ ì‹¤í–‰

```bash
cd server/visionstory_backend
npm install
node src/index.js
```

### 2. Flutter ì•± ì‹¤í–‰

```bash
flutter run -d chrome
```

### 3. í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

#### ì‹œë‚˜ë¦¬ì˜¤ A: ì •ìƒ íë¦„
1. ê°•ì‚¬ëª…, ì†Œê°œ ì…ë ¥
2. ì´ë¯¸ì§€, ì˜¤ë””ì˜¤ ì—…ë¡œë“œ
3. "ì•„ë°”íƒ€ ì˜ìƒ ìƒì„±" ë²„íŠ¼ í´ë¦­
4. ì§„í–‰ ìƒí™© ì¹´ë“œ í‘œì‹œ:
   - 1/3: ì•„ë°”íƒ€ ìƒì„± ì¤‘...
   - 2/3: ì˜ìƒ ìƒì„± ì¤‘...
   - 3/3: ì™„ë£Œ!
5. ë¹„ë””ì˜¤ ìë™ ì¬ìƒ

#### ì‹œë‚˜ë¦¬ì˜¤ B: ì•± ì¢…ë£Œ í›„ ì¬ì§„ì…
1. ìƒì„± ì¤‘ ì•± ì¢…ë£Œ (ë¸Œë¼ìš°ì € ë‹«ê¸°)
2. ë‹¤ì‹œ ì•± ì‹¤í–‰
3. âš ï¸ í˜„ì¬: ì‘ì—… IDë¥¼ ëª¨ë¥´ë©´ í™•ì¸ ë¶ˆê°€
4. ğŸ”œ ê°œì„ : "ë‚´ ì‘ì—… ëª©ë¡" í˜ì´ì§€ ì¶”ê°€ ì˜ˆì •

#### ì‹œë‚˜ë¦¬ì˜¤ C: ì˜¤ë¥˜ ì²˜ë¦¬
1. VPN ì—†ì´ í…ŒìŠ¤íŠ¸ (ì§€ì—­ ì œí•œ)
2. ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ:
   - "VisionStory isn't currently supported in your country"
3. ìƒíƒœê°€ `failed`ë¡œ ë³€ê²½

## ğŸ“Š ì§„í–‰ ìƒí™© ë‹¨ê³„

### Step 1: ì•„ë°”íƒ€ ìƒì„± (1/3)
- VisionStory APIì— ì´ë¯¸ì§€ ì—…ë¡œë“œ
- ì•„ë°”íƒ€ ID ìƒì„±

### Step 2: ë¹„ë””ì˜¤ ìƒì„± ìš”ì²­ (2/3)
- ì•„ë°”íƒ€ ID + ì˜¤ë””ì˜¤ë¡œ ë¹„ë””ì˜¤ ìƒì„± ìš”ì²­
- ë¹„ë””ì˜¤ ID ìƒì„±

### Step 3: ë¹„ë””ì˜¤ ì™„ë£Œ ëŒ€ê¸° (3/3)
- 10ì´ˆë§ˆë‹¤ ìƒíƒœ í™•ì¸ (í´ë§)
- ì™„ë£Œ ì‹œ URL ë°›ìŒ

## ğŸ”„ ì‹¤ì‹œê°„ ë™ê¸°í™”

Flutter ì•±ì—ì„œ Firestoreë¥¼ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë‹:

```dart
FirebaseFirestore.instance
  .collection('avatarJobs')
  .doc(jobId)
  .snapshots()
  .listen((snapshot) {
    // ìƒíƒœ ë³€ê²½ ì‹œ ìë™ UI ì—…ë°ì´íŠ¸
  });
```

## âš ï¸ í˜„ì¬ ì œí•œì‚¬í•­

### 1. VisionStory ì§€ì—­ ì œí•œ
- **ë¬¸ì œ**: í•œêµ­ì—ì„œ 403 ì˜¤ë¥˜
- **í•´ê²°**: VPN ì‚¬ìš© ë˜ëŠ” Cloud Runì„ ë¯¸êµ­ ë¦¬ì „ì— ë°°í¬

### 2. ì‘ì—… ëª©ë¡ í˜ì´ì§€ ì—†ìŒ
- **ë¬¸ì œ**: ì•±ì„ ê»ë‹¤ ì¼œë©´ ì§„í–‰ ì¤‘ì¸ ì‘ì—… IDë¥¼ ëª¨ë¦„
- **í•´ê²°**: "ë‚´ ì•„ë°”íƒ€" ëª©ë¡ í˜ì´ì§€ ì¶”ê°€ í•„ìš”

### 3. ì‚¬ìš©ì ì¸ì¦ ë¯¸êµ¬í˜„
- **í˜„ì¬**: userIdë¥¼ í•˜ë“œì½”ë”© ("user_123")
- **ê°œì„ **: Firebase Auth ì—°ë™ í•„ìš”

## ğŸ¯ ë‹¤ìŒ ë‹¨ê³„

### 1. ì‘ì—… ëª©ë¡ í˜ì´ì§€
```dart
// lib/presentation/pages/avatar/avatar_list_page.dart
// ë‚´ ì•„ë°”íƒ€ ëª©ë¡ ë³´ê¸°
// ì§„í–‰ ì¤‘/ì™„ë£Œ/ì‹¤íŒ¨ í•„í„°ë§
```

### 2. ìŠ¬ë¼ì´ë“œë³„ ì˜ìƒ ìƒì„±ìœ¼ë¡œ í™•ì¥
```javascript
// 100ê°œ ìŠ¬ë¼ì´ë“œ ì²˜ë¦¬
POST /projects/{projectId}/generate-videos
{
  slides: [
    { slideId, script, avatarImageUrl },
    // ... 100ê°œ
  ]
}
```

### 3. í‘¸ì‹œ ì•Œë¦¼
```dart
// ì™„ë£Œ ì‹œ ì•Œë¦¼
FirebaseMessaging.instance.onMessage.listen((message) {
  // "ì•„ë°”íƒ€ ì˜ìƒì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
});
```

### 4. Cloud Run ë°°í¬
```bash
# Dockerfile ì´ë¯¸ ì¤€ë¹„ë¨
gcloud run deploy visionstory-backend \
  --region us-central1 \
  --allow-unauthenticated
```

## ğŸ’¡ í•µì‹¬ ê°œë…

### Cloud Runì€ ì™œ ì¢…ë£Œë˜ì§€ ì•Šë‚˜ìš”?

**ì˜¤í•´**: "ë°±ê·¸ë¼ìš´ë“œ ì‘ì—… ì¤‘ Cloud Runì´ ì¢…ë£Œë˜ì§€ ì•Šë‚˜ìš”?"

**ë‹µë³€**: 
- âœ… HTTP ì—°ê²°ì´ ì—´ë ¤ìˆìœ¼ë©´ Cloud Runì€ ì‚´ì•„ìˆìŒ
- âœ… `processAvatarGeneration()` í•¨ìˆ˜ ì‹¤í–‰ ì¤‘ì—ëŠ” ì¸ìŠ¤í„´ìŠ¤ ìœ ì§€
- âœ… ì™„ë£Œ í›„ ì‘ë‹µ ë°˜í™˜í•˜ë©´ ê·¸ë•Œ ì—°ê²° ì¢…ë£Œ
- âœ… 5ë¶„ í›„ ìƒˆ ìš”ì²­ ì—†ìœ¼ë©´ ì¸ìŠ¤í„´ìŠ¤ ì¢…ë£Œ

**ë¹„ìœ **:
```
ë ˆìŠ¤í† ë‘(Cloud Run)ì—ì„œ ì£¼ë¬¸(HTTP ìš”ì²­)
    â†“
ì¦‰ì‹œ ì£¼ë¬¸ ë²ˆí˜¸ ë°›ìŒ (jobId)
    â†“
ì£¼ë°©ì—ì„œ ìš”ë¦¬ ì¤‘ (ë°±ê·¸ë¼ìš´ë“œ ì‘ì—…)
    â†“
ë ˆìŠ¤í† ë‘ì€ ìš”ë¦¬ê°€ ëë‚  ë•Œê¹Œì§€ ì˜ì—… ì¤‘ âœ…
    â†“
ìš”ë¦¬ ì™„ë£Œ â†’ ì†ë‹˜ ì•Œë¦¼
```

## ğŸ“ í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] ë°±ì—”ë“œ ì„œë²„ ì‹œì‘ í™•ì¸
- [ ] Flutter ì•±ì—ì„œ íŒŒì¼ ì—…ë¡œë“œ
- [ ] ì‘ì—… ìƒì„± ë° jobId ë°˜í™˜ í™•ì¸
- [ ] Firestoreì—ì„œ ì‘ì—… ë¬¸ì„œ ìƒì„± í™•ì¸
- [ ] ì§„í–‰ ìƒí™© ì¹´ë“œ í‘œì‹œ í™•ì¸
- [ ] ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ í™•ì¸ (1/3 â†’ 2/3 â†’ 3/3)
- [ ] ì™„ë£Œ ì‹œ ë¹„ë””ì˜¤ ìë™ ì¬ìƒ í™•ì¸
- [ ] ì•± ìƒˆë¡œê³ ì¹¨ í›„ ìƒíƒœ ìœ ì§€ í™•ì¸ (TODO)

## ğŸ› ë¬¸ì œ í•´ê²°

### "Failed to initialize Firebase"
```bash
# Firebase í”„ë¡œì íŠ¸ ì„¤ì •
export GOOGLE_APPLICATION_CREDENTIALS="path/to/serviceAccount.json"
```

### "Firestore permission denied"
```javascript
// Firestore ê·œì¹™
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /avatarJobs/{jobId} {
      allow read, write: if true;  // ê°œë°œìš©
    }
  }
}
```

### "Backend not responding"
```bash
# ë°±ì—”ë“œ ë¡œê·¸ í™•ì¸
tail -f /Users/ihuijae/.cursor/projects/.../terminals/3.txt
```

## ğŸ‰ ì™„ë£Œ!

**ë¹„ë™ê¸° ì•„ë°”íƒ€ ìƒì„± ì‹œìŠ¤í…œì´ ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!**

ì´ì œ ì´ êµ¬ì¡°ë¥¼ ìŠ¬ë¼ì´ë“œë³„ ì˜ìƒ ìƒì„±ì—ë„ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

